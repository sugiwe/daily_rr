# Ruby/Rails デイリードリル - 2026-02-01（セッション1）

## 本日のドリル

### 問題1
以下のRubyコードの出力として正しいものはどれですか？

```ruby
def test_method(arg1, arg2 = :default, *rest, **options)
  p [arg1, arg2, rest, options]
end

test_method("a", "b", "c", "d", x: 1, y: 2)
```

**選択肢：**
- a) `["a", "b", ["c", "d"], {x: 1, y: 2}]`
- b) `["a", "b", ["c", "d", {:x=>1, :y=>2}], {}]`
- c) `["a", :default, ["b", "c", "d"], {x: 1, y: 2}]`
- d) `["a", "b", ["c"], {:d=>nil, :x=>1, :y=>2}]`

**正解：** a

**解説：**
この問題は、Rubyの引数の仕組みについて問うています。特に、可変長引数（`*rest`）とキーワード引数（`**options`）の動作を理解する必要があります。

まず、メソッド定義を分解しましょう：
```ruby
def test_method(arg1, arg2 = :default, *rest, **options)
```

1. `arg1`: 通常の必須引数
2. `arg2 = :default`: デフォルト値を持つオプション引数
3. `*rest`: アスタリスク1つは「可変長引数」と呼ばれ、余った位置引数を配列として受け取る
4. `**options`: アスタリスク2つは「キーワード引数」と呼ばれ、名前付き引数をハッシュとして受け取る

メソッド呼び出し時、引数は以下のように割り当てられます：
```ruby
test_method("a", "b", "c", "d", x: 1, y: 2)
```

- `"a"` → `arg1` に割り当て
- `"b"` → `arg2` に割り当て（デフォルト値は使われない）
- `"c", "d"` → 残りの位置引数として `*rest` に配列 `["c", "d"]` として割り当て
- `x: 1, y: 2` → キーワード引数として `**options` にハッシュ `{x: 1, y: 2}` として割り当て

したがって、出力は `["a", "b", ["c", "d"], {x: 1, y: 2}]` になります。

**公式リファレンス:**
- [メソッド呼び出し - Ruby 3.2 リファレンス](https://docs.ruby-lang.org/ja/latest/doc/spec=2fcall.html)
- [キーワード引数 - Ruby 3.2 リファレンス](https://docs.ruby-lang.org/ja/latest/doc/spec=2fdef.html#keyword)

---

### 問題2
以下のRailsのコントローラコードにおける問題点として最も適切なものはどれですか？

```ruby
class ArticlesController < ApplicationController
  def create
    @article = Article.new(params[:article])
    @article.save
    redirect_to @article
  end
end
```

**選択肢：**
- a) `params[:article]` を直接使用しているため、セキュリティリスクがある
- b) `@article.save` の返り値をチェックしていないため、保存失敗時にも成功時と同じ処理が実行される
- c) `redirect_to` の代わりに `render` を使用すべき
- d) インスタンス変数 `@article` を使用しているため、メモリリークが発生する可能性がある

**正解：** a

**解説：**
このコントローラには「マスアサインメント脆弱性」と呼ばれる重大なセキュリティリスクがあります。`params[:article]` を直接 `Article.new` に渡すと、ユーザーが送信したすべてのパラメータがそのままモデルに割り当てられてしまいます。

これにより、例えば `admin` や `user_id` など、本来ユーザーが変更できないはずの属性も変更可能になってしまう危険性があります。

Rails 4以降では、この問題に対処するために「ストロングパラメータ」パターンを使うことが推奨されています：

```ruby
def create
  @article = Article.new(article_params)  # 直接paramsを使用しない
  
  if @article.save  # 保存結果をチェックする
    redirect_to @article
  else
    render :new
  end
end

private

def article_params
  params.require(:article).permit(:title, :content, :category_id)  # 許可する属性を明示的に指定
end
```

他の選択肢についても触れておくと：
- b) これも実際には問題ですが、セキュリティリスクに比べると緊急性は低いです
- c) リダイレクトvsレンダリングはコンテキストによって適切な使い分けがあります
- d) インスタンス変数の使用はRailsの標準的なパターンで問題ありません

**公式リファレンス:**
- [Rails セキュリティガイド - マスアサインメント](https://railsguides.jp/security.html#%E3%83%9E%E3%82%B9%E3%82%A2%E3%82%B5%E3%82%A4%E3%83%B3%E3%83%A1%E3%83%B3%E3%83%88)
- [Strong Parameters - Rails API](https://api.rubyonrails.org/classes/ActionController/StrongParameters.html)

---

### 問題3
以下のRubyコードの実行結果はどうなりますか？

```ruby
class A
  def self.class_method
    "Class method called"
  end
  
  def instance_method
    self.class.class_method
  end
end

puts A.new.instance_method
```

**選択肢：**
- a) "Class method called"
- b) "Instance method called"
- c) エラー: undefined method `class_method` for A:Class
- d) エラー: undefined method `instance_method` for #<A:0x...>

**正解：** a

**解説：**
このコードは、インスタンスメソッドからクラスメソッドを呼び出す方法を示しています。

コードの流れを追ってみましょう：

1. クラス`A`にクラスメソッド`self.class_method`が定義されています。これは文字列`"Class method called"`を返します。

2. 同じく`A`にインスタンスメソッド`instance_method`が定義されています。このメソッド内で`self.class.class_method`を呼び出しています。
   - ここで`self`は現在のインスタンス（`A.new`で作られたオブジェクト）を指します
   - `self.class`はそのインスタンスのクラス、つまり`A`クラスを取得します
   - `self.class.class_method`は`A.class_method`を呼び出すことになります

3. 最後の行で`A.new.instance_method`を実行しています：
   - `A.new`で`A`のインスタンスを作成
   - そのインスタンスの`instance_method`を呼び出し
   - その中で`A.class_method`が実行され、`"Class method called"`が返される

したがって、出力結果は`"Class method called"`になります。

このパターンは、インスタンスメソッドからクラスメソッドにアクセスしたい場合に便利です。例えば、インスタンス固有の処理と共通処理を適切に分離する場合などに使われます。

**公式リファレンス:**
- [クラス/メソッド定義 - Ruby 3.2 リファレンス](https://docs.ruby-lang.org/ja/latest/doc/spec=2fdef.html)
- [クラス/クラスメソッド - Ruby 3.2 リファレンス](https://docs.ruby-lang.org/ja/latest/doc/spec=2fdef.html#class_method)

---

## 結果

**正解数：** 3/3

**今日のポイント：**
1. Rubyの引数の種類と処理順序（必須引数、デフォルト値付き引数、可変長引数`*rest`、キーワード引数`**options`）
2. Railsのセキュリティ対策（マスアサインメント脆弱性とストロングパラメータの使用）
3. Rubyにおけるクラスメソッドとインスタンスメソッドの関係、およびそれらの相互呼び出し方法